!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Loader={},t.THREE)}(this,(function(t,e){"use strict";function i(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var n=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,n.get?n:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var n=i(e);const s=/\n/,r=/\s/;function h(t,e,i){for(let n=0;n<t.kernings.length;n++){const s=t.kernings[n];if(!(s.first<e)&&!(s.second<i))return s.first>e||s.first===e&&s.second>i?0:s.amount}return 0}class a extends n.BufferGeometry{font;text;width;alignX;alignY;size;letterSpacing;lineHeight;wordSpacing;wordBreak;textScale;computedWidth;computedHeight;lineCount;constructor({font:t,text:e,width:i=1/0,alignX:n="left",alignY:s="top",size:r=1,letterSpacing:h=0,lineHeight:a=1.4,wordSpacing:o=0,wordBreak:d=!1,useUv:f=!0,usecharPosition:l=!0}={}){super(),this.font=t,this.text=e,this.width=i,this.alignX=n,this.alignY=s,this.size=r,this.letterSpacing=h,this.lineHeight=a,this.wordSpacing=o,this.wordBreak=d,this.textScale=this.size/(this.font.common.baseline||this.font.common.base),this.generateGeometry({uv:f,position:!0,charUv:!0,index:!0,charPosition:l})}generateGeometry({uv:t=!0,position:e=!0,charUv:i=!0,index:s=!0,charPosition:r=!0}={}){const h=this.text.replace(/[ \n]/g,"").length;this.setAttribute("position",new n.BufferAttribute(new Float32Array(4*h*3),3)),this.setAttribute("charUv",new n.BufferAttribute(new Float32Array(4*h*2),2)),r&&this.setAttribute("charPosition",new n.BufferAttribute(new Float32Array(4*h*3),3)),t&&this.setAttribute("uv",new n.BufferAttribute(new Float32Array(4*h*2),2)),s&&(this.setAttribute("charIndex",new n.BufferAttribute(new Float32Array(4*h),1)),this.setAttribute("charIndex",new n.BufferAttribute(new Float32Array(4*h),1)),this.setAttribute("lineCharIndex",new n.BufferAttribute(new Float32Array(4*h),1))),this.setAttribute("id",new n.BufferAttribute(new Float32Array(4*h),1));const a=new Uint32Array(6*h);for(let t=0;t<h;t++)this.attributes.id.array.set([t,t,t,t],4*t),a.set([4*t,4*t+2,4*t+1,4*t+1,4*t+2,4*t+3],6*t);t&&(this.boundingBox=new n.Box3),this.setIndex(Array.from(a)),this.generateLayout()}generateLayout(){const t=[];let e=0,i=0,n=0,a=o();function o(){const s={index:t.length,width:0,chars:[]};return t.push(s),i=e,n=0,s}let d=0;for(;e<this.text.length&&d<100;){d++;const t=this.text[e];if(!a.width&&r.test(t)){e++,i=e,n=0;continue}if(s.test(t)){e++,a=o();continue}const f=this.font.glyphs[t]||this.font.glyphs[" "];if(!f)throw new Error(`Missing glyph "${t}"`);if(a.chars.length&&f){const t=a.chars[a.chars.length-1].glyph,e=h(this.font.data,f.id||0,t.id)*this.textScale;a.width+=e,n+=e}a.chars.push({glyph:f,x:a.width,y:0,lineIndex:a.index,lineCharIndex:a.chars.length});let l=0;if(r.test(t)?(i=e,n=0,l+=this.wordSpacing*this.size):l+=this.letterSpacing*this.size,l+=f.xadvance*this.textScale,a.width+=l,n+=l,a.width>this.width){if(this.wordBreak&&a.chars.length>1){a.width-=l,a.chars.pop(),a=o();continue}if(!this.wordBreak&&n!==a.width){const t=e-i+1;a.chars.splice(-t,t),e=i,a.width-=n,a=o();continue}}e++,d=0}a.width||t.pop(),this.lineCount=t.length,this.computedHeight=this.lineCount*this.size*this.lineHeight,this.computedWidth=Math.max(...t.map((t=>t.width))),this.populateBuffers(t)}populateBuffers(t){const e=this.font.common.scaleW,i=this.font.common.scaleH,n=this.computedHeight,s=this.computedWidth;let h=.07*this.size,a=0;"center"===this.alignY?h+=this.computedHeight/2:"bottom"===this.alignY&&(h+=this.computedHeight);let o=0;for(let d=0;d<t.length;d++){const f=t[d];for(let t=0;t<f.chars.length;t++){const d=f.chars[t].glyph;if(a=f.chars[t].x,"center"===this.alignX?a-=.5*f.width:"right"===this.alignX&&(a-=f.width),r.test(d.char))continue;a+=d.xoffset*this.textScale,h-=d.yoffset*this.textScale;const l=d.width*this.textScale,u=d.height*this.textScale;this.attributes.position.array.set([a,h-u,0,a,h,0,a+l,h-u,0,a+l,h,0],4*o*3),this.attributes.charPosition&&this.attributes.charPosition.array.set([a,h-u,0,a,h,0,a+l,h-u,0,a+l,h,0],4*o*3),this.attributes.uv&&this.attributes.uv.array.set([a/s,1-(h-u)/-n,a/s,1-h/-n,(a+l)/s,1-(h-u)/-n,(a+l)/s,1-h/-n],4*o*2);const c=d.x/e,g=d.width/e,m=1-d.y/i,p=d.height/i;this.attributes.charUv.array.set([c,m-p,c,m,c+g,m-p,c+g,m],4*o*2),this.attributes.charPosition.array.set([c,m-p,c,m,c+g,m-p,c+g,m],4*o*3),h+=d.yoffset*this.textScale,o++}h-=this.size*this.lineHeight}}resize(t){this.width=t,this.generateGeometry()}updateText(t){this.text=t,this.generateGeometry()}}e.ShaderChunk.msdftest_fragment="#define GLSLIFY 1\n#define SQRT2DIV2 0.7071067811865476\nfloat uThreshold=0.05;float uStrokeOutsetWidth=0.0;float uStrokeInsetWidth=0.5;vec3 uStrokeColor=vec3(1.0,0.0,0.0);\n#ifdef USE_MSDF_GEOMETRY\nvec3 msdfTexel=texture2D(uAtlas,vCharUv).rgb;float signedDist=max(min(msdfTexel.r,msdfTexel.g),min(max(msdfTexel.r,msdfTexel.g),msdfTexel.b))-0.5;float msdfD=fwidth(signedDist);\n#ifdef USE_THRESHOLD\nfloat msdfTest=smoothstep(uThreshold-SQRT2DIV2,uThreshold+SQRT2DIV2,signedDist);\n#else\nfloat msdfTest=smoothstep(-msdfD,msdfD,signedDist);\n#endif\nif(msdfTest<0.01)discard;float signedDistOutset=signedDist+uStrokeOuterWidth*0.5;float signedDistInset=signedDist-uStrokeInnerWidth*0.5;\n#ifdef USE_THRESHOLD\nfloat outerAlpha=smoothstep(uThreshold-SQRT2DIV2,uThreshold+SQRT2DIV2,signedDistOutset);float innerAlpha=1.0;\n#ifdef USE_STROKE\ninnerAlpha-=smoothstep(uThreshold-SQRT2DIV2,uThreshold+SQRT2DIV2,signedDistInset);\n#endif\n#else\nfloat outerAlpha=clamp(signedDistOutset/fwidth(signedDistOutset)+0.5,0.0,1.0);float innerAlpha=1.0;\n#ifdef USE_STROKE\ninnerAlpha-=clamp(signedDistInset/fwidth(signedDistInset)+0.5,0.0,1.0);\n#endif\n#endif\ndiffuseColor.a*=outerAlpha*innerAlpha;\n#endif\n",e.ShaderChunk.msdftest_pars_fragment="#define GLSLIFY 1\n#ifdef USE_MSDF_GEOMETRY\nvarying vec2 vCharUv;uniform sampler2D uAtlas;\n#ifdef USE_STROKE\nuniform float uStrokeOuterWidth;uniform float uStrokeInnerWidth;\n#else\nfloat uStrokeOuterWidth=0.0;float uStrokeInnerWidth=1.0;\n#endif\n#endif\n",e.ShaderChunk.msdf_glyph_uv_vertex="#define GLSLIFY 1\n#ifdef USE_MSDF_GEOMETRY\nvCharUv=charUv;\n#endif\n",e.ShaderChunk.msdf_glyph_uv_pars_vertex="#define GLSLIFY 1\n#ifdef USE_MSDF_GEOMETRY\nattribute vec2 charUv;varying vec2 vCharUv;\n#endif\n",Object.keys(e.ShaderLib).forEach((t=>{const i=e.ShaderLib[t];i.fragmentShader=i.fragmentShader.replace("#include <alphatest_pars_fragment>","#include <alphatest_pars_fragment>\n#include <msdftest_pars_fragment>"),i.fragmentShader=i.fragmentShader.replace("#include <alphatest_fragment>","#include <alphatest_fragment>\n#include <msdftest_fragment>"),i.vertexShader=i.vertexShader.replace("#include <uv_pars_vertex>","#include <uv_pars_vertex>\n#include <msdf_glyph_uv_pars_vertex>"),i.vertexShader=i.vertexShader.replace("#include <uv_vertex>","#include <uv_vertex>\n#include <msdf_glyph_uv_vertex>")})),t.Font=class{data={};glyphs={};common={};constructor(t){this.data=t,this.common=t.common,t.chars.forEach((t=>this.glyphs[t.char]=t))}},t.MSDFGeometry=a,t.extendMaterial=function(t,{atlas:e,threshold:i,stroke:n,strokeInnerWidth:s=.5,strokeOuterWidth:r=0}={}){const h={userCallback:null,msdfCallback:(t,a)=>{const o=t;o.defines||(o.defines={}),o.uniforms||(o.uniforms={});const d=void 0!==i,f=!!n;o.defines.USE_MSDF_GEOMETRY="",o.uniforms.uAtlas={value:e},d&&(o.defines.USE_THRESHOLD="",o.uniforms.uThreshold={value:i||0}),f&&(o.defines.USE_STROKE="",o.uniforms.uStrokeOuterWidth={value:r},o.uniforms.uStrokeInnerWidth={value:s}),console.log(o.uniforms),h.userCallback&&h.userCallback(t,a)}};return Object.defineProperty(t,"onBeforeCompile",{get:()=>h.msdfCallback,set(t){h.userCallback=t}}),t},Object.defineProperty(t,"__esModule",{value:!0})}));
